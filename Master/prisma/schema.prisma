// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  RECRUITER
}

enum JobSource {
  LINKEDIN
  INDEED
  NAUKRI
  OTHER
}

enum ApplicationStage {
  IDENTIFIED
  RESUME_UPDATED
  COLD_MESSAGE_SENT
  CONNECTION_ACCEPTED
  APPLIED
  INTERVIEW_SCHEDULED
  OFFER
  REJECTED
  CLOSED
}

enum ApplicationActionType {
  APPLIED
  OUTREACH
  FOLLOW_UP
  INTERVIEW
  OFFER
  REJECTION
  NOTE
}

enum JobStatus {
  ACTIVE
  CLOSED
  FILLED
}

enum NotificationType {
  FOLLOW_UP_REMINDER
  INTERVIEW_ALERT
  OVERDUE_TASK
  AI_INSIGHT
  JOB_SCRAPE_CONFIRMATION
}

enum NotificationChannel {
  WHATSAPP
  EMAIL
  IN_APP
}

enum FileType {
  RESUME
  DOCUMENT
  IMAGE
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  LOST
}

enum ClientStatus {
  ACTIVE
  INACTIVE
}

enum ServiceType {
  STANDARD
  PREMIUM
  EXECUTIVE
  CONTRACT
  CUSTOM
}

enum DocumentType {
  JOB_SEARCH_STRATEGY
  CONTRACT
  AGREEMENT
  OTHER
}

enum AttachmentType {
  FILE
  LINK
  TEXT
}

enum RevenueStatus {
  PENDING
  PARTIAL
  PAID
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  NOTE
  TASK
  FOLLOW_UP
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  password            String
  firstName           String
  lastName            String
  role                UserRole  @default(RECRUITER)
  managerId           String? // For manager-recruiter relationship
  isActive            Boolean   @default(true)
  lastLogin           DateTime?
  locked              Boolean   @default(false)
  lockCount           Int       @default(0)
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  jobs                    Job[]
  candidates              Candidate[]
  applications            Application[]
  applicationActions      ApplicationAction[]     @relation("ApplicationActions")
  applicationAttachments  ApplicationAttachment[] @relation("ApplicationAttachments")
  notifications           Notification[]
  auditLogs               AuditLog[]
  managedRecruiters       User[]                  @relation("ManagerRecruiter")
  manager                 User?                   @relation("ManagerRecruiter", fields: [managerId], references: [id])
  leads                   Lead[]
  clients                 Client[]                @relation("ClientAssignedUser")
  reverseRecruiterClients Client[]                @relation("ClientReverseRecruiter")
  followUps               FollowUp[]
  activities              Activity[]
  revenues                Revenue[]
  payments                Payment[]
  automationRules         AutomationRule[]
  messageTemplates        MessageTemplate[]
  sentMessages            Message[]
  systemConfigs           SystemConfig[]
  leadDocuments           LeadDocument[]
  onboardingForms         OnboardingForm[]

  @@map("users")
}

model Job {
  id                 String    @id @default(cuid())
  title              String
  company            String
  location           String
  description        String    @db.Text
  source             JobSource
  sourceUrl          String?
  skills             String[] // Array of skills
  experienceRequired String?
  salaryRange        String?
  status             JobStatus @default(ACTIVE)
  recruiterId        String
  notes              String?   @db.Text
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Duplicate Detection
  isDuplicate     Boolean @default(false)
  duplicateOf     String? // Reference to original job ID
  similarityScore Float? // Similarity score (0-100) if duplicate

  // Relations
  recruiter    User          @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  applications Application[]

  @@index([recruiterId])
  @@index([source])
  @@index([status])
  @@index([createdAt])
  @@index([isDuplicate])
  @@map("jobs")
}

model Candidate {
  id                  String   @id @default(cuid())
  firstName           String
  lastName            String
  email               String
  phone               String?
  linkedinUrl         String?
  tags                String[] // Array of tags
  notes               String?  @db.Text
  assignedRecruiterId String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  assignedRecruiter User     @relation(fields: [assignedRecruiterId], references: [id], onDelete: Cascade)
  resumes           Resume[]

  @@map("candidates")
}

model Application {
  id             String           @id @default(cuid())
  jobId          String?          // Optional: application can exist without a linked job
  clientId       String?          // Changed from candidateId to clientId (nullable for migration)
  stage          ApplicationStage @default(IDENTIFIED)
  recruiterId    String
  notes          String?          @db.Text
  followUpDate   DateTime?
  stageChangedAt DateTime?       // Track when stage was last changed for days calculation
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  job         Job?                    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  client      Client?                 @relation(fields: [clientId], references: [id], onDelete: Cascade)
  recruiter   User                    @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  actions     ApplicationAction[]
  attachments ApplicationAttachment[]

  // Note: Unique constraint removed temporarily for migration (can be re-added after data migration)
  @@index([stage])
  @@index([recruiterId])
  @@index([clientId]) // Added index for clientId
  @@index([createdAt])
  @@index([followUpDate])
  @@map("applications")
}

model ApplicationAction {
  id            String                @id @default(cuid())
  applicationId String
  type          ApplicationActionType
  description   String?               @db.Text
  performedById String
  performedAt   DateTime              @default(now())
  createdAt     DateTime              @default(now())

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  performedBy User        @relation("ApplicationActions", fields: [performedById], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([performedAt])
  @@map("application_actions")
}

model ApplicationAttachment {
  id            String         @id @default(cuid())
  applicationId String
  type          AttachmentType
  fileUrl       String? // For FILE type
  fileName      String? // For FILE type
  fileSize      Int? // For FILE type (in bytes)
  linkUrl       String? // For LINK type
  linkTitle     String? // For LINK type
  textContent   String?        @db.Text // For TEXT type
  uploadedBy    String
  uploadedAt    DateTime       @default(now())
  description   String?        @db.Text

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  uploader    User        @relation("ApplicationAttachments", fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([type])
  @@index([uploadedAt])
  @@map("application_attachments")
}

model Resume {
  id          String   @id @default(cuid())
  candidateId String
  fileUrl     String
  fileName    String
  fileSize    Int // in bytes
  version     Int      @default(1)
  uploadedBy  String
  uploadedAt  DateTime @default(now())

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@map("resumes")
}

model CoverLetter {
  id         String   @id @default(cuid())
  clientId   String
  fileUrl    String
  fileName   String
  fileSize   Int // in bytes
  version    Int      @default(1)
  uploadedBy String
  uploadedAt DateTime @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("cover_letters")
}

model ClientDocument {
  id          String       @id @default(cuid())
  clientId    String
  type        DocumentType
  fileUrl     String
  fileName    String
  fileSize    Int // in bytes
  version     Int          @default(1)
  uploadedBy  String
  uploadedAt  DateTime     @default(now())
  description String?      @db.Text

  // Relations
  client            Client  @relation("ClientDocuments", fields: [clientId], references: [id], onDelete: Cascade)
  clientJobStrategy Client? @relation("ClientJobSearchStrategy")

  @@index([clientId])
  @@index([type])
  @@map("client_documents")
}

model Notification {
  id        String              @id @default(cuid())
  userId    String
  type      NotificationType
  channel   NotificationChannel
  title     String
  message   String              @db.Text
  read      Boolean             @default(false)
  sent      Boolean             @default(false)
  sentAt    DateTime?
  createdAt DateTime            @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String // e.g., "CREATE_JOB", "UPDATE_CANDIDATE"
  entity    String // e.g., "Job", "Candidate"
  entityId  String?
  details   String?  @db.Text
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

model File {
  id         String   @id @default(cuid())
  fileName   String
  fileUrl    String
  fileType   FileType
  fileSize   Int // in bytes
  mimeType   String
  uploadedBy String
  createdAt  DateTime @default(now())

  @@map("files")
}

model Lead {
  id             String     @id @default(cuid())
  firstName      String     // Person (job seeker) first name
  lastName       String     // Person (job seeker) last name
  currentCompany String?    // Optional: where they work or referring company
  email          String?
  phone          String?
  status         LeadStatus @default(NEW)
  assignedUserId String
  source         String?
  industry       String?
  estimatedValue Decimal?   @db.Decimal(10, 2)
  notes          String?    @db.Text
  convertedAt    DateTime?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relations
  assignedUser User            @relation(fields: [assignedUserId], references: [id], onDelete: Cascade)
  client       Client?         @relation("LeadToClient")
  activities   Activity[]
  followUps    FollowUp[]
  revenues     Revenue[]
  documents    LeadDocument[]

  @@index([status])
  @@index([assignedUserId])
  @@map("leads")
}

model LeadDocument {
  id              String   @id @default(cuid())
  leadId          String
  fileName        String   // Storage object key (for delete)
  fileUrl         String
  originalFileName String  // Display name
  fileSize        Int      // bytes
  mimeType        String?
  uploadedBy      String
  uploadedAt      DateTime @default(now())

  // Relations
  lead     Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  uploader User @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("lead_documents")
}

model OnboardingForm {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  fields      Json     // JSON array of field definitions: key, label, type, required?, options?
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy   User                      @relation(fields: [createdById], references: [id], onDelete: Cascade)
  submissions OnboardingFormSubmission[]

  @@index([createdById])
  @@map("onboarding_forms")
}

model OnboardingFormSubmission {
  id        String   @id @default(cuid())
  formId    String
  data      Json       // JSON object of field key -> value (answers)
  clientId  String?  // Set when converted to client
  submittedAt DateTime @default(now())

  form   OnboardingForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  client Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([formId])
  @@index([clientId])
  @@map("onboarding_form_submissions")
}

model Client {
  id             String       @id @default(cuid())
  firstName      String
  lastName       String
  email          String?
  phone          String?
  address        String?      @db.Text
  status         ClientStatus @default(ACTIVE)
  assignedUserId String
  leadId         String? // For conversion from lead

  // Preparation Pipeline Fields
  serviceType            ServiceType? // Step 2: Service package type
  onboardedDate          DateTime? // Step 3: Official onboarding date (or use createdAt)
  reverseRecruiterId     String? // Step 4: Reverse recruiter assignment
  whatsappGroupCreated   Boolean      @default(false) // Step 5: WhatsApp group status
  whatsappGroupId        String? // Step 5: WhatsApp group ID/link
  whatsappGroupCreatedAt DateTime? // Step 5: Group creation timestamp
  jobSearchStrategyDocId String?      @unique // Step 6: Strategy document reference
  gmailId                String? // Step 7: Gmail account ID
  gmailCreated           Boolean      @default(false) // Step 7: Gmail creation status
  gmailCreatedAt         DateTime? // Step 7: Gmail creation timestamp
  linkedInOptimized      Boolean      @default(false) // Step 9: LinkedIn optimization status
  linkedInOptimizedAt    DateTime? // Step 9: Optimization timestamp
  jobSearchInitiated     Boolean      @default(false) // Step 10: Ready for applications
  jobSearchInitiatedAt   DateTime? // Step 10: Initiation timestamp

  // Existing Fields
  industry        String? // Industry they want to work in
  currentJobTitle String? // Current job title (if employed)
  experience      String? // Years of experience
  skills          String[] // Skills/interests
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  assignedUser      User             @relation("ClientAssignedUser", fields: [assignedUserId], references: [id], onDelete: Cascade)
  reverseRecruiter  User?            @relation("ClientReverseRecruiter", fields: [reverseRecruiterId], references: [id], onDelete: SetNull)
  lead              Lead?            @relation("LeadToClient", fields: [leadId], references: [id], onDelete: SetNull)
  jobSearchStrategy ClientDocument?  @relation("ClientJobSearchStrategy", fields: [jobSearchStrategyDocId], references: [id], onDelete: SetNull)
  activities        Activity[]
  followUps         FollowUp[]
  revenues          Revenue[]
  payments          Payment[]
  coverLetters      CoverLetter[]
  documents         ClientDocument[] @relation("ClientDocuments")
  applications      Application[]
  onboardingSubmissions OnboardingFormSubmission[]

  @@unique([leadId])
  @@index([status])
  @@index([assignedUserId])
  @@index([reverseRecruiterId])
  @@index([serviceType])
  @@index([jobSearchInitiated])
  @@map("clients")
}

model FollowUp {
  id             String    @id @default(cuid())
  leadId         String?
  clientId       String?
  assignedUserId String
  title          String
  description    String?   @db.Text
  scheduledDate  DateTime
  completed      Boolean   @default(false)
  completedAt    DateTime?
  notes          String?   @db.Text
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  assignedUser User    @relation(fields: [assignedUserId], references: [id], onDelete: Cascade)
  lead         Lead?   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  client       Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([scheduledDate])
  @@index([assignedUserId])
  @@index([completed])
  @@map("follow_ups")
}

model Activity {
  id             String       @id @default(cuid())
  leadId         String?
  clientId       String?
  assignedUserId String
  type           ActivityType
  title          String
  description    String?      @db.Text
  occurredAt     DateTime     @default(now())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  assignedUser User    @relation(fields: [assignedUserId], references: [id], onDelete: Cascade)
  lead         Lead?   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  client       Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([occurredAt])
  @@index([assignedUserId])
  @@index([type])
  @@map("activities")
}

model Revenue {
  id             String        @id @default(cuid())
  leadId         String?
  clientId       String?
  assignedUserId String
  amount         Decimal       @db.Decimal(10, 2)
  status         RevenueStatus @default(PENDING)
  invoiceNumber  String?
  dueDate        DateTime?
  paidDate       DateTime?
  description    String?       @db.Text
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  assignedUser User      @relation(fields: [assignedUserId], references: [id], onDelete: Cascade)
  lead         Lead?     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  client       Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  payments     Payment[]

  @@index([status])
  @@index([assignedUserId])
  @@index([dueDate])
  @@map("revenues")
}

model Payment {
  id             String   @id @default(cuid())
  revenueId      String
  clientId       String
  assignedUserId String
  amount         Decimal  @db.Decimal(10, 2)
  paymentDate    DateTime @default(now())
  paymentMethod  String? // e.g., "Bank Transfer", "Credit Card", "Cash"
  reference      String? // Payment reference number
  notes          String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  assignedUser User    @relation(fields: [assignedUserId], references: [id], onDelete: Cascade)
  revenue      Revenue @relation(fields: [revenueId], references: [id], onDelete: Cascade)
  client       Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([paymentDate])
  @@index([assignedUserId])
  @@map("payments")
}

enum RuleEntity {
  LEAD
  CLIENT
  FOLLOW_UP
  APPLICATION
  REVENUE
  PAYMENT
}

enum RuleConditionOperator {
  EQUALS
  NOT_EQUALS
  GREATER_THAN
  LESS_THAN
  GREATER_THAN_OR_EQUAL
  LESS_THAN_OR_EQUAL
  CONTAINS
  NOT_CONTAINS
  IS_NULL
  IS_NOT_NULL
  DAYS_SINCE
  DAYS_UNTIL
}

enum RuleActionType {
  NOTIFY_EMPLOYEE
  NOTIFY_MANAGER
  NOTIFY_ADMIN
  ESCALATE
  CREATE_ACTIVITY
  UPDATE_STATUS
  CREATE_FOLLOW_UP
}

model AutomationRule {
  id          String     @id @default(cuid())
  name        String
  description String?    @db.Text
  entity      RuleEntity
  enabled     Boolean    @default(true)
  priority    Int        @default(0) // Higher priority runs first
  conditions  String     @db.Text // JSON array of conditions
  actions     String     @db.Text // JSON array of actions
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  createdBy   String
  lastRunAt   DateTime?
  runCount    Int        @default(0)

  // Relations
  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([entity])
  @@index([enabled])
  @@index([priority])
  @@map("automation_rules")
}

enum MessageChannel {
  WHATSAPP
  EMAIL
  SMS
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
  BOUNCED
}

enum MessageTemplateType {
  FOLLOW_UP
  INTERVIEW_REMINDER
  OFFER_LETTER
  WELCOME
  REJECTION
  CUSTOM
}

model MessageTemplate {
  id        String              @id @default(cuid())
  name      String
  type      MessageTemplateType
  channel   MessageChannel
  subject   String? // For email
  content   String              @db.Text
  variables String?             @db.Text // JSON array of variable names
  enabled   Boolean             @default(true)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  createdBy String

  // Relations
  creator  User      @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([type])
  @@index([channel])
  @@index([enabled])
  @@map("message_templates")
}

model Message {
  id             String         @id @default(cuid())
  templateId     String?
  channel        MessageChannel
  recipientType  String // "candidate", "client", "lead", "user"
  recipientId    String
  recipientPhone String? // For WhatsApp/SMS
  recipientEmail String? // For Email
  subject        String? // For email
  content        String         @db.Text
  status         MessageStatus  @default(PENDING)
  sentAt         DateTime?
  deliveredAt    DateTime?
  readAt         DateTime?
  errorMessage   String?        @db.Text
  retryCount     Int            @default(0)
  maxRetries     Int            @default(3)
  externalId     String? // ID from WhatsApp/Email service
  metadata       String?        @db.Text // JSON for additional data
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  sentBy         String

  // Relations
  template MessageTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  sender   User             @relation(fields: [sentBy], references: [id], onDelete: Cascade)

  @@index([recipientId])
  @@index([status])
  @@index([channel])
  @@index([sentAt])
  @@index([templateId])
  @@map("messages")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  category    String // e.g., "whatsapp", "ai", "email", "system", "limits"
  description String?  @db.Text
  updatedBy   String
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  // Relations
  updater User @relation(fields: [updatedBy], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([key])
  @@map("system_configs")
}
