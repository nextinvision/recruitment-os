// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  RECRUITER
}

enum JobSource {
  LINKEDIN
  INDEED
  NAUKRI
  OTHER
}

enum ApplicationStage {
  IDENTIFIED
  RESUME_UPDATED
  COLD_MESSAGE_SENT
  CONNECTION_ACCEPTED
  APPLIED
  INTERVIEW_SCHEDULED
  OFFER
  REJECTED
  CLOSED
}

enum JobStatus {
  ACTIVE
  CLOSED
  FILLED
}

enum NotificationType {
  FOLLOW_UP_REMINDER
  INTERVIEW_ALERT
  OVERDUE_TASK
  AI_INSIGHT
  JOB_SCRAPE_CONFIRMATION
}

enum NotificationChannel {
  WHATSAPP
  EMAIL
  IN_APP
}

enum FileType {
  RESUME
  DOCUMENT
  IMAGE
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  LOST
}

enum ClientStatus {
  ACTIVE
  INACTIVE
}

enum RevenueStatus {
  PENDING
  PARTIAL
  PAID
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  NOTE
  TASK
  FOLLOW_UP
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(RECRUITER)
  managerId String?  // For manager-recruiter relationship
  isActive  Boolean  @default(true)
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  jobs              Job[]
  candidates        Candidate[]
  applications      Application[]
  notifications     Notification[]
  auditLogs         AuditLog[]
  managedRecruiters User[]        @relation("ManagerRecruiter")
  manager           User?         @relation("ManagerRecruiter", fields: [managerId], references: [id])
  leads             Lead[]
  clients           Client[]
  followUps         FollowUp[]
  activities        Activity[]
  revenues          Revenue[]
  payments          Payment[]
  automationRules   AutomationRule[]
  messageTemplates  MessageTemplate[]
  sentMessages      Message[]

  @@map("users")
}

model Job {
  id               String     @id @default(cuid())
  title            String
  company          String
  location         String
  description      String     @db.Text
  source           JobSource
  sourceUrl        String?
  skills           String[]   // Array of skills
  experienceRequired String?
  salaryRange      String?
  status           JobStatus  @default(ACTIVE)
  recruiterId      String
  notes            String?    @db.Text
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // Relations
  recruiter    User          @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  applications Application[]

  @@map("jobs")
}

model Candidate {
  id                  String   @id @default(cuid())
  firstName           String
  lastName            String
  email               String
  phone               String?
  linkedinUrl         String?
  tags                String[] // Array of tags
  notes               String?  @db.Text
  assignedRecruiterId String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  assignedRecruiter User          @relation(fields: [assignedRecruiterId], references: [id], onDelete: Cascade)
  applications      Application[]
  resumes           Resume[]

  @@map("candidates")
}

model Application {
  id          String           @id @default(cuid())
  jobId       String
  candidateId String
  stage       ApplicationStage @default(IDENTIFIED)
  recruiterId String
  notes       String?          @db.Text
  followUpDate DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  job      Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  recruiter User    @relation(fields: [recruiterId], references: [id], onDelete: Cascade)

  @@unique([jobId, candidateId])
  @@map("applications")
}

model Resume {
  id          String   @id @default(cuid())
  candidateId String
  fileUrl     String
  fileName    String
  fileSize    Int      // in bytes
  version     Int      @default(1)
  uploadedBy  String
  uploadedAt  DateTime @default(now())

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@map("resumes")
}

model Notification {
  id        String            @id @default(cuid())
  userId    String
  type      NotificationType
  channel   NotificationChannel
  title     String
  message   String            @db.Text
  read      Boolean           @default(false)
  sent      Boolean           @default(false)
  sentAt    DateTime?
  createdAt DateTime          @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String   // e.g., "CREATE_JOB", "UPDATE_CANDIDATE"
  entity    String   // e.g., "Job", "Candidate"
  entityId  String?
  details   String?  @db.Text
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

model File {
  id        String   @id @default(cuid())
  fileName  String
  fileUrl   String
  fileType  FileType
  fileSize  Int      // in bytes
  mimeType  String
  uploadedBy String
  createdAt DateTime @default(now())

  @@map("files")
}

model Lead {
  id            String     @id @default(cuid())
  companyName   String
  contactName   String
  email         String?
  phone         String?
  status        LeadStatus @default(NEW)
  assignedUserId String
  source        String?    // Where the lead came from
  industry      String?
  estimatedValue Decimal?  @db.Decimal(10, 2)
  notes         String?    @db.Text
  convertedAt   DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  assignedUser User       @relation(fields: [assignedUserId], references: [id], onDelete: Cascade)
  client       Client?    @relation("LeadToClient")
  activities   Activity[]
  followUps    FollowUp[]
  revenues     Revenue[]

  @@index([status])
  @@index([assignedUserId])
  @@map("leads")
}

model Client {
  id            String      @id @default(cuid())
  firstName      String
  lastName      String
  email         String?
  phone         String?
  address       String?     @db.Text
  status        ClientStatus @default(ACTIVE)
  assignedUserId String
  leadId        String?     // For conversion from lead
  industry      String?     // Industry they want to work in
  currentJobTitle String?   // Current job title (if employed)
  experience    String?     // Years of experience
  skills        String[]   // Skills/interests
  notes         String?     @db.Text
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  assignedUser User       @relation(fields: [assignedUserId], references: [id], onDelete: Cascade)
  lead         Lead?      @relation("LeadToClient", fields: [leadId], references: [id], onDelete: SetNull)
  activities   Activity[]
  followUps    FollowUp[]
  revenues     Revenue[]
  payments     Payment[]

  @@unique([leadId])

  @@index([status])
  @@index([assignedUserId])
  @@map("clients")
}

model FollowUp {
  id            String   @id @default(cuid())
  leadId        String?
  clientId      String?
  assignedUserId String
  title         String
  description   String?  @db.Text
  scheduledDate DateTime
  completed     Boolean  @default(false)
  completedAt   DateTime?
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  assignedUser User    @relation(fields: [assignedUserId], references: [id], onDelete: Cascade)
  lead         Lead?   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  client       Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([scheduledDate])
  @@index([assignedUserId])
  @@index([completed])
  @@map("follow_ups")
}

model Activity {
  id            String       @id @default(cuid())
  leadId        String?
  clientId      String?
  assignedUserId String
  type          ActivityType
  title         String
  description   String?      @db.Text
  occurredAt    DateTime     @default(now())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  assignedUser User    @relation(fields: [assignedUserId], references: [id], onDelete: Cascade)
  lead         Lead?   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  client      Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([occurredAt])
  @@index([assignedUserId])
  @@index([type])
  @@map("activities")
}

model Revenue {
  id            String        @id @default(cuid())
  leadId        String?
  clientId      String?
  assignedUserId String
  amount        Decimal       @db.Decimal(10, 2)
  status        RevenueStatus @default(PENDING)
  invoiceNumber String?
  dueDate       DateTime?
  paidDate      DateTime?
  description   String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  assignedUser User     @relation(fields: [assignedUserId], references: [id], onDelete: Cascade)
  lead         Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  client       Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  payments     Payment[]

  @@index([status])
  @@index([assignedUserId])
  @@index([dueDate])
  @@map("revenues")
}

model Payment {
  id            String   @id @default(cuid())
  revenueId     String
  clientId      String
  assignedUserId String
  amount        Decimal  @db.Decimal(10, 2)
  paymentDate   DateTime @default(now())
  paymentMethod String?  // e.g., "Bank Transfer", "Credit Card", "Cash"
  reference     String?  // Payment reference number
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  assignedUser User    @relation(fields: [assignedUserId], references: [id], onDelete: Cascade)
  revenue      Revenue @relation(fields: [revenueId], references: [id], onDelete: Cascade)
  client       Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([paymentDate])
  @@index([assignedUserId])
  @@map("payments")
}

enum RuleEntity {
  LEAD
  CLIENT
  FOLLOW_UP
  APPLICATION
  REVENUE
  PAYMENT
}

enum RuleConditionOperator {
  EQUALS
  NOT_EQUALS
  GREATER_THAN
  LESS_THAN
  GREATER_THAN_OR_EQUAL
  LESS_THAN_OR_EQUAL
  CONTAINS
  NOT_CONTAINS
  IS_NULL
  IS_NOT_NULL
  DAYS_SINCE
  DAYS_UNTIL
}

enum RuleActionType {
  NOTIFY_EMPLOYEE
  NOTIFY_MANAGER
  NOTIFY_ADMIN
  ESCALATE
  CREATE_ACTIVITY
  UPDATE_STATUS
  CREATE_FOLLOW_UP
}

model AutomationRule {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  entity      RuleEntity
  enabled     Boolean  @default(true)
  priority    Int      @default(0) // Higher priority runs first
  conditions  String   @db.Text // JSON array of conditions
  actions     String   @db.Text // JSON array of actions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String
  lastRunAt   DateTime?
  runCount    Int      @default(0)

  // Relations
  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([entity])
  @@index([enabled])
  @@index([priority])
  @@map("automation_rules")
}

enum MessageChannel {
  WHATSAPP
  EMAIL
  SMS
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
  BOUNCED
}

enum MessageTemplateType {
  FOLLOW_UP
  INTERVIEW_REMINDER
  OFFER_LETTER
  WELCOME
  REJECTION
  CUSTOM
}

model MessageTemplate {
  id          String             @id @default(cuid())
  name        String
  type        MessageTemplateType
  channel     MessageChannel
  subject     String?            // For email
  content     String             @db.Text
  variables   String?             @db.Text // JSON array of variable names
  enabled     Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  createdBy   String

  // Relations
  creator User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([type])
  @@index([channel])
  @@index([enabled])
  @@map("message_templates")
}

model Message {
  id              String        @id @default(cuid())
  templateId      String?
  channel         MessageChannel
  recipientType   String        // "candidate", "client", "lead", "user"
  recipientId     String
  recipientPhone  String?       // For WhatsApp/SMS
  recipientEmail  String?       // For Email
  subject         String?       // For email
  content         String        @db.Text
  status          MessageStatus @default(PENDING)
  sentAt          DateTime?
  deliveredAt     DateTime?
  readAt          DateTime?
  errorMessage    String?       @db.Text
  retryCount      Int           @default(0)
  maxRetries      Int           @default(3)
  externalId      String?       // ID from WhatsApp/Email service
  metadata        String?       @db.Text // JSON for additional data
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  sentBy          String

  // Relations
  template MessageTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  sender   User            @relation(fields: [sentBy], references: [id], onDelete: Cascade)

  @@index([recipientId])
  @@index([status])
  @@index([channel])
  @@index([sentAt])
  @@index([templateId])
  @@map("messages")
}

